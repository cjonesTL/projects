---
- name: Install the Zabbix agent
  yum:
    name: http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.8-1.el7.x86_64.rpm
- name: Configure the Zabbix agent
  replace:
    path: /etc/zabbix/zabbix_agentd.conf
    regexp: '{{item.regexp}}'
    replace: '{{item.replace}}'
  with_items:
    - {regexp: "^Server=127.0.0.1$", replace: "Server={{zabbix_server}}"}
    - {regexp: "^ServerActive=127.0.0.1$", replace: "ServerActive={{zabbix_server}}"}
    - {regexp: "^Hostname=Zabbix server$", replace: "Hostname={{ansible_hostname}}"}
  vars:
    - zabbix_server: itmonitor.timberlinkaustralia.com.au
- name: Start the Zabbix agent service
  service:
    name: zabbix-agent
    state: started
    enabled: yes
- name: Create a new host or update an existing host's info
  local_action:
    module: zabbix_host
    server_url: http://itmonitor.timberlinkaustralia.com.au
    login_user: zabbix-admin
    login_password: zabbix-admin-password
    host_name: '{{ansible_hostname}}'
    host_groups:
      - Virtual machines
      - Azure - Cluster Kubernetes
    link_templates:
      - Template OS Linux
      - Template App Docker
    interfaces:
      - type: 1
        main: 1
        useip: 1
        ip: '{{ansible_ssh_host}}'
        dns: ""
        port: 10050